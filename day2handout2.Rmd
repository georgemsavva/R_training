---
title: "day2handout2"
author: "George Savva"
date: "07/01/2021"
output: html_document
---


`r example("Transformations")`

Just as we can apply mathematical functions to objects representing single numbers and vectors, we can apply them to columns in our data frame to transform or combine variables.

For example, suppose we want to log transform the height variable, and create a new variable called logHeight.  Then we would use:

```{r }
TreeData$logHeight <- log(TreeData$height)
```

As when dealing with vectors above, R will apply the function individually to each element of the column, creatig a new variable in our data.

Check that this variable has been created.

Now we can plot the new variable against dgl:
```{r }
plot( logHeight ~ dgl, data = TreeData)
```




`r example("Linear regression")`

In the previous section we saw that dgl could be used to predict tree height.  We can estimate a linear model for this relationship using the lm() function

```{r }
lm1 <-  lm( height ~ dgl, data=TreeData  )
```

Note this function uses the same 'formula' interface as the t-test, boxplot functions above.

`lm()` creates a ‘linear model’ object.  The linear model object contains the all the details of an estimated linear regression model with ‘height’ as the outcome and ‘dgl’ as the predictor.

There are now lots of different functions you can use to extract elements of this model.
To see a description of all the information contained within the object, use:

```{r }
attributes(lm1)
```

But generally you won’t need to use these attributes directly.  Different functions exist to extract the information in readable and usable formats:

The summary command that we used earlier can also ‘summarise’ a linear model.  It produces the standard linear regression output that you would expect from any statistics package.

```{r }
summary(lm1)
```

To get the corresponding analysis of variance table, use the anova() function:

```{r }
anova(lm1) # Note by default R returns ‘type III’ ANOVA.
```

To plot the data with the regression model added, use the ‘plot’ function as previously, then abline() to add the line:

```{r }
plot( height ~ dgl, data = TreeData)
abline(lm1, col="red")
```


`r example("REGRESSION PREDICTIONS AND DIAGNOSTICS, working with CATEGORICAL VARIABLES (FACTORS)")`

After estimating a regression model we should inspect it to check its underlying assumptions are met.   R will show you some useful diagnostic plots if you run:

```{r }
plot(lm1)
```

If we want to directly check the predicted values or residuals from the model we can use the predict and resid functions

```{ r}
predict(lm1)
resid(lm1)
```

These functions generate vectors with each element corresponding to a row in the original data frame.  So element [1] of the vector created by predict() is the predicted (fitted) value of height for the first row in TreeData under our model.

`r example("Using factors to represent categorical variables")`

So far we have not considered how R represents categorial variables.  R has a special type called a 'factor' whereby categories are represented by integers corresponding to groups, with each integer given a text label.  We'll illustrate their use with a simple example:

## A model with a categorical predictor

Suppose we wanted to model the relationship between tree height and species.  'Species' is a categorical variable, rather than a continuous numeric as dgl was, but the way in which we estimate the model in R is the same. That is, we do this by running:

```{r }
lm2 <-  lm( height ~ species.name, data=TreeData  )
summary(lm2)
```

Notice that we did not need to create any 'dummy' variables to indicate the different levels, R did this automatically, and chose the level with the lowest value (alphabetically) to be the reference value. 

Because the species.name variable was a ‘character’ variable, R understood that we wanted it to be analysed in categories (just as it did when we estimated the box plots).

Much of the time, if we try to use a character variable in an analysis, R will interpret this as a factor.

If we had used the numeric species number variable, then R would not have automatically realised this, and we would get a non-sensical regression.

```{r }
lm3 <-  lm( height ~ species, data=TreeData  )
summary(lm3)
```

To make R treat a numeric variable as categorical it needs to be turned into a ‘factor’ variable.  A factor is a numeric variable where the numbers just represent groups, they lose their meaning as numbers.

Rather than overwriting the species numeric variable, we’ll create a new one for the factor:

First we’ll check the class of TreeData$species and ask for a summary:

```{r }
class(TreeData$species)
summary(TreeData$species)
```

We see a summary that is suitable for a continuous numeric (mean, median etc)

Now make a new factor variable and add it to the dataframe:

```{r }
TreeData$speciesF <- factor(TreeData$species)
```

Now check the class and the summary again.  R realises that a factor should be summarised by a tabulation not mean, median etc.

```{r }
class(TreeData$speciesF)
summary(TreeData$speciesF)
```

Finally the regression model should look sensible again, that is with one row per category (compared to a reference group).

```{r }
lm4 <- lm( height ~ speciesF, data=TreeData  )
summary(lm4)
```

Exercise
a)	Are the regression coefficients the same as those estimated for model 2?  If not, why not?
b)	The function `tbl_regression()` in the `gtsummary` package provides nicely laid out summaries of regression models.  Give it a try.



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
